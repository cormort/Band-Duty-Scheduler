<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨‚åœ˜å€¼ç­è¡¨ç”¢ç”Ÿå™¨ (æœ€çµ‚å®Œæ•´ç‰ˆ)</title>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            background-color: #f0f2f5;
        }
        h2 { color: #333; text-align: center; margin-bottom: 20px; }

        /* --- Tooltip (æç¤ºæ¡†) æ¨£å¼ --- */
        [data-tooltip] {
            position: relative;
            cursor: help;
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            animation: fadeIn 0.2s forwards;
        }
        [data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 115%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #333;
            opacity: 0;
            animation: fadeIn 0.2s forwards;
        }
        @keyframes fadeIn {
            to { opacity: 1; transform: translateX(-50%) translateY(-5px); }
        }

        /* --- å€å¡Šä½ˆå±€ --- */
        .config-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #444;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        /* æ—¥æœŸå€å¡Š */
        .date-range-global {
            text-align: center;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid #bbdefb;
        }
        .date-range-global input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
        }

        .action-card {
            padding: 20px;
            border-radius: 10px;
            background: #fff;
            border: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* å¡ç‰‡é ‚éƒ¨é¡è‰²æ¢ */
        .card-ab { border-top: 5px solid #4CAF50; }
        .card-silk { border-top: 5px solid #9C27B0; }
        .card-training { border-top: 5px solid #FF5722; background-color: #fff8f5; }

        .card-header { font-weight: bold; font-size: 1.2em; color: #333; text-align: center; }

        /* è¼¸å…¥æ¬„ä½æ¨£å¼ */
        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
        }
        .input-row label { width: 30%; color: #666; font-weight: bold; }
        .input-row input[type="text"] {
            width: 65%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        /* æ˜ŸæœŸé¸æ“‡å™¨æ¨£å¼ */
        .day-selector {
            display: flex;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #eee;
        }
        .day-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            font-size: 0.9em;
            color: #555;
            flex: 1;
        }
        .day-label:hover { background-color: #e8f5e9; border-radius: 4px; }
        .day-label input { margin-bottom: 5px; cursor: pointer; transform: scale(1.2); }

        /* æŒ‰éˆ•æ¨£å¼ */
        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: white;
            transition: all 0.2s;
            margin-top: auto;
        }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:active { transform: translateY(0); }

        .btn-ab { background-color: #4CAF50; }
        .btn-silk { background-color: #9C27B0; }
        .btn-train { background-color: #FF5722; }
        .btn-all { background-color: #333; }
        
        /* å¿«é€Ÿè¼‰å…¥å­¸æœŸæŒ‰éˆ• */
        .quick-btn-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        button.btn-quick {
            width: auto;
            padding: 6px 18px;
            margin-top: 0;
            font-size: 0.95em;
            font-weight: normal;
            background-color: #fff;
            color: #1976D2;
            border: 1px solid #1976D2;
            border-radius: 20px;
        }
        button.btn-quick:hover {
            background-color: #1976D2;
            color: #fff;
        }

        /* åº•éƒ¨æŒ‰éˆ•å€ */
        .toolbar {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
        }
        .btn-copy { background-color: #2196F3; width: auto; padding: 12px 30px; }
        .btn-clear { background-color: white; border: 1px solid #ccc; color: #666; width: auto; padding: 12px 25px; }
        .btn-clear:hover { background-color: #ffebee; color: #d32f2f; border-color: #d32f2f; }

        /* è¡¨æ ¼æ¨£å¼ */
        .table-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow-x: auto;
            min-height: 300px;
        }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th, td {
            border: 1px solid #e0e0e0;
            padding: 10px;
            text-align: center;
            vertical-align: middle;
        }
        th { background-color: #f8f9fa; color: #495057; font-weight: bold; }
        
        /* è¡¨æ ¼å…§è¼¸å…¥æ¡† */
        input.editable-cell {
            width: 95%;
            border: 1px solid transparent;
            text-align: center;
            font-size: 15px;
            background: transparent;
            font-family: inherit;
            padding: 6px 0;
        }
        input.editable-cell:hover, input.editable-cell:focus {
            border: 1px solid #2196F3;
            background: #fff;
            border-radius: 4px;
        }
        
        /* è¡¨æ ¼å…§æ“ä½œæŒ‰éˆ•å€ */
        .action-cell { display: flex; gap: 8px; justify-content: center; }
        .icon-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 4px;
            width: auto;
            transition: background 0.2s;
        }
        .add-row-btn { color: #4CAF50; background: #e8f5e9; }
        .add-row-btn:hover { background: #4CAF50; color: white; }
        
        .del-btn { color: #f44336; background: #ffebee; }
        .del-btn:hover { background: #f44336; color: white; }
    </style>
</head>
<body>

    <h2>æ¨‚åœ˜å€¼ç­è¡¨ç”¢ç”Ÿå™¨ (æœ€çµ‚å®Œæ•´ç‰ˆ)</h2>

    <div class="config-section">
        <div class="section-title">Step 1: è¨­å®šå­¸æœŸä¾‹è¡Œåœ˜ç·´</div>
        <div class="date-range-global">
            <div>
                <span data-tooltip="è«‹é¸æ“‡å­¸æœŸçš„ç¬¬ä¸€å¤©èˆ‡æœ€å¾Œä¸€å¤©">ğŸ“… å­¸æœŸå€é–“ï¼š</span>
                <input type="date" id="semStartDate"> è‡³ 
                <input type="date" id="semEndDate">
            </div>
            
            <div class="quick-btn-group">
                <button class="btn-quick" onclick="quickSetSemester(1)" data-tooltip="è‡ªå‹•å¡«å…¥ï¼š8/30 ~ éš”å¹´ 1/20">ä¸Š(ç¬¬ä¸€)å­¸æœŸ</button>
                <button class="btn-quick" onclick="quickSetSemester(2)" data-tooltip="è‡ªå‹•å¡«å…¥ï¼š2/11 ~ 6/30">ä¸‹(ç¬¬äºŒ)å­¸æœŸ</button>
            </div>
        </div>

        <div class="action-grid">
            <div class="action-card card-ab">
                <div class="card-header" data-tooltip="è¨­å®š A/B åœ˜çš„ä¾‹è¡Œç·´ç¿’">ğŸ» A/B åœ˜</div>
                
                <div class="day-selector" id="daysAB" data-tooltip="å‹¾é¸ A/B åœ˜è¦ç·´ç¿’çš„æ˜ŸæœŸ">
                    <label class="day-label"><input type="checkbox" value="1"><span>ä¸€</span></label>
                    <label class="day-label"><input type="checkbox" value="2" checked><span>äºŒ</span></label>
                    <label class="day-label"><input type="checkbox" value="3"><span>ä¸‰</span></label>
                    <label class="day-label"><input type="checkbox" value="4" checked><span>å››</span></label>
                    <label class="day-label"><input type="checkbox" value="5"><span>äº”</span></label>
                </div>

                <div class="input-row">
                    <label data-tooltip="è‹¥æ˜¯é€±äºŒï¼Œå°‡ä½¿ç”¨æ­¤å…§å®¹">é€±äºŒå…§å®¹</label>
                    <input type="text" id="txtAB_Tue" value="Aåœ˜åˆ†çµ„ï¼Båœ˜åˆå¥">
                </div>
                <div class="input-row">
                    <label data-tooltip="è‹¥æ˜¯é€±å››ï¼Œå°‡ä½¿ç”¨æ­¤å…§å®¹">é€±å››å…§å®¹</label>
                    <input type="text" id="txtAB_Thu" value="Aåœ˜åˆå¥ï¼Båœ˜åˆ†çµ„">
                </div>
                <div class="input-row">
                    <label data-tooltip="è‹¥å‹¾é¸é€±ä¸€ä¸‰äº”ï¼Œå°‡ä½¿ç”¨æ­¤å…§å®¹">å…¶ä»–å¤©</label>
                    <input type="text" id="txtAB_Other" value="A/Båœ˜åŠ ç·´">
                </div>
                <div class="input-row">
                    <label>ç·´ç¿’æ™‚é–“</label>
                    <input type="text" id="timeAB" value="16:00~18:30" data-tooltip="è¨­å®šæ™‚é–“">
                </div>
                <button class="btn-ab" onclick="generateSemester('AB')" data-tooltip="æ¸…é™¤èˆŠè¡¨ï¼Œåƒ…ç”¢ç”Ÿ A/B åœ˜è¡Œç¨‹">ç”¢ç”Ÿ A/B åœ˜è¡¨</button>
            </div>

            <div class="action-card card-silk">
                <div class="card-header" data-tooltip="è¨­å®šçµ²ç«¹åœ˜çš„ä¾‹è¡Œç·´ç¿’">ğŸ‹ çµ²ç«¹åœ˜</div>

                <div class="day-selector" id="daysSilk" data-tooltip="å‹¾é¸çµ²ç«¹åœ˜è¦ç·´ç¿’çš„æ˜ŸæœŸ">
                    <label class="day-label"><input type="checkbox" value="1"><span>ä¸€</span></label>
                    <label class="day-label"><input type="checkbox" value="2"><span>äºŒ</span></label>
                    <label class="day-label"><input type="checkbox" value="3" checked><span>ä¸‰</span></label>
                    <label class="day-label"><input type="checkbox" value="4"><span>å››</span></label>
                    <label class="day-label"><input type="checkbox" value="5"><span>äº”</span></label>
                </div>

                <div class="input-row">
                    <label>æ´»å‹•å…§å®¹</label>
                    <input type="text" id="txtSilk" value="çµ²ç«¹åœ˜åˆå¥" data-tooltip="çµ²ç«¹åœ˜æ´»å‹•åç¨±">
                </div>
                <div class="input-row">
                    <label>ç·´ç¿’æ™‚é–“</label>
                    <input type="text" id="timeSilk" value="12:00~15:00" data-tooltip="è¨­å®šæ™‚é–“">
                </div>
                <button class="btn-silk" onclick="generateSemester('Silk')" data-tooltip="æ¸…é™¤èˆŠè¡¨ï¼Œåƒ…ç”¢ç”Ÿçµ²ç«¹åœ˜è¡Œç¨‹">ç”¢ç”Ÿ çµ²ç«¹åœ˜è¡¨</button>
            </div>
            
            <div class="action-card" style="border-top: 5px solid #333;">
                <div class="card-header">âœ¨ å­¸æœŸç¸½è¡¨</div>
                <div style="font-size: 0.9em; color: #666; text-align: center; margin: 10px 0; flex-grow: 1; display: flex; align-items: center; justify-content: center;">
                    å°‡ A/B åœ˜èˆ‡çµ²ç«¹åœ˜çš„æ‰€æœ‰è¨­å®š<br>åˆä½µç”¢ç”Ÿå‡ºä¸€ä»½å®Œæ•´çš„ç¸½è¡¨
                </div>
                <button class="btn-all" onclick="generateSemester('All')" data-tooltip="ä¾ç…§æ‰€æœ‰å‹¾é¸è¨­å®šç”¢ç”Ÿå®Œæ•´è¡¨æ ¼">ç”¢ç”Ÿ åˆä½µç¸½è¡¨</button>
            </div>
        </div>
    </div>

    <div class="config-section" style="border: 2px solid #FF5722;">
        <div class="section-title" style="color: #FF5722; border-color: #ffd8cc;">Step 2: åŠ å…¥æš‘è¨“ / å¯’è¨“ (é€£çºŒæ—¥æœŸ)</div>
        <div class="action-grid" style="grid-template-columns: 1fr;">
            <div class="action-card card-training" style="flex-direction: row; flex-wrap: wrap; align-items: flex-end; justify-content: center;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label>é–‹å§‹ï¼š</label><input type="date" id="trainStartDate" style="padding: 8px;" data-tooltip="è¨“ç·´ç¬¬ä¸€å¤©">
                    <label>çµæŸï¼š</label><input type="date" id="trainEndDate" style="padding: 8px;" data-tooltip="è¨“ç·´æœ€å¾Œä¸€å¤©">
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="trainName" value="æ¨‚åœ˜æš‘è¨“" placeholder="æ´»å‹•åç¨±" style="padding: 8px; width: 120px;" data-tooltip="è¨“ç·´åç¨±">
                    <input type="text" id="trainTime" value="09:00~16:00" placeholder="æ™‚é–“" style="padding: 8px; width: 100px;" data-tooltip="è¨“ç·´æ™‚é–“">
                </div>
                <button class="btn-train" style="width: auto; padding: 10px 20px;" onclick="addTrainingBatch()" data-tooltip="ä¿ç•™ç¾æœ‰è¡¨æ ¼ï¼Œå°‡é€™äº›æ—¥æœŸæ’å…¥ä¸¦æ’åº">ï¼‹ åŠ å…¥è¨“ç·´æ—¥ç¨‹</button>
            </div>
        </div>
        <div style="text-align: center; color: #FF5722; font-size: 0.9em; margin-top: 10px;">
            ğŸ’¡ æ­¤åŠŸèƒ½æ¡ã€Œç´¯åŠ ã€æ¨¡å¼ï¼Œä¸æœƒæ¸…é™¤ä¸Šæ–¹å·²å»ºç«‹çš„è³‡æ–™ï¼Œä¸”æœƒè‡ªå‹•è·³éé€±å…­èˆ‡é€±æ—¥ã€‚
        </div>
    </div>

    <div class="toolbar">
        <button class="btn-copy" onclick="copyTable()" data-tooltip="è¤‡è£½è¡¨æ ¼å…§å®¹ï¼Œå¯ç›´æ¥åœ¨ Excel æŒ‰è²¼ä¸Š">ğŸ“‹ è¤‡è£½è¡¨æ ¼åˆ° Excel</button>
        <button class="btn-clear" onclick="clearTable()" data-tooltip="åˆªé™¤è¡¨æ ¼å…§æ‰€æœ‰è³‡æ–™">ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨</button>
    </div>

    <div class="table-container">
        <table id="scheduleTable">
            <thead>
                <tr>
                    <th style="width: 100px;">æ—¥æœŸ</th>
                    <th style="width: 60px;">æ˜ŸæœŸ</th>
                    <th style="width: 250px;">å€¼ç­æ™‚æ®µ/æ´»å‹•å…§å®¹</th>
                    <th style="width: 130px;">æ™‚é–“</th>
                    <th>å€¼ç­å®¶é•·ä¸€</th>
                    <th>å€¼ç­å®¶é•·äºŒ</th>
                    <th>å€¼ç­å®¶é•·ä¸‰</th>
                    <th style="width: 100px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
        <div id="emptyMsg" style="text-align: center; color: #999; padding: 50px;">
            è¡¨æ ¼ç›®å‰æ˜¯ç©ºçš„ï¼Œè«‹ç”±ä¸Šæ–¹è¨­å®šä¸¦é»æ“Šã€Œç”¢ç”Ÿã€æŒ‰éˆ•
        </div>
    </div>

    <datalist id="activityOptions">
        <option value="Aåœ˜åˆå¥ï¼Båœ˜åˆ†çµ„">
        <option value="Aåœ˜åˆ†çµ„ï¼Båœ˜åˆå¥">
        <option value="çµ²ç«¹åœ˜åˆå¥">
        <option value="çµ²ç«¹åŠ ç·´">
        <option value="Aåœ˜åŠ ç·´">
        <option value="Båœ˜åŠ ç·´">
        <option value="æ¨‚åœ˜æš‘è¨“">
        <option value="åˆ†éƒ¨æš‘è¨“">
        <option value="æˆç™¼å½©æ’">
    </datalist>

    <script>
        // --- åˆå§‹åŒ–è¨­å®š ---
        window.onload = function() {
            const today = new Date();
            const currentMonth = today.getMonth() + 1;

            // æ™ºæ…§åˆ¤æ–·ï¼šç›®å‰å¦‚æœæ˜¯ 2æœˆ~7æœˆï¼Œè‡ªå‹•è¼‰å…¥ã€Œä¸‹å­¸æœŸã€ï¼Œå¦å‰‡è¼‰å…¥ã€Œä¸Šå­¸æœŸã€
            if (currentMonth >= 2 && currentMonth <= 7) {
                quickSetSemester(2);
            } else {
                quickSetSemester(1);
            }
            
            // é è¨­æš‘è¨“ï¼šä¸‹é€±ä¸€ ~ ä¸‹é€±äº” (æ–¹ä¾¿ä½¿ç”¨è€…æ“ä½œ)
            const nextMon = new Date();
            nextMon.setDate(today.getDate() + (1 + 7 - today.getDay()) % 7);
            const nextFri = new Date(nextMon);
            nextFri.setDate(nextMon.getDate() + 4);
            
            // è™•ç†æ—¥æœŸæ ¼å¼ YYYY-MM-DD
            document.getElementById('trainStartDate').value = formatDate(nextMon);
            document.getElementById('trainEndDate').value = formatDate(nextFri);
        };

        // --- å¿«é€Ÿè¼‰å…¥å­¸æœŸæ—¥æœŸ (è·¨å¹´åº¦æ™ºæ…§åˆ¤æ–·) ---
        function quickSetSemester(term) {
            const today = new Date();
            let y = today.getFullYear();
            let m = today.getMonth() + 1;

            if (term === 1) {
                // ä¸Š(ç¬¬ä¸€)å­¸æœŸï¼š8/30 ~ éš”å¹´ 1/20
                if (m <= 2) {
                    y = y - 1; // å¦‚æœæ˜¯ 1ã€2 æœˆæŒ‰ç¬¬ä¸€å­¸æœŸï¼Œé€šå¸¸æ˜¯æŒ‡å‰›çµæŸçš„é‚£ä¸€å­¸æœŸ
                }
                document.getElementById('semStartDate').value = `${y}-08-30`;
                document.getElementById('semEndDate').value = `${y+1}-01-20`;
            } else if (term === 2) {
                // ä¸‹(ç¬¬äºŒ)å­¸æœŸï¼š2/11 ~ 6/30
                if (m >= 8) {
                    y = y + 1; // å¦‚æœæ˜¯ä¸‹åŠå¹´æŒ‰ç¬¬äºŒå­¸æœŸï¼Œé€šå¸¸æ˜¯æŒ‡æ˜å¹´çš„äº‹
                }
                document.getElementById('semStartDate').value = `${y}-02-11`;
                document.getElementById('semEndDate').value = `${y}-06-30`;
            }
        }

        // å°‡ Date ç‰©ä»¶è½‰ç‚º YYYY-MM-DD æ ¼å¼
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        const daysMap = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

        function getSelectedDays(containerId) {
            const checkboxes = document.querySelectorAll(`#${containerId} input[type="checkbox"]:checked`);
            return Array.from(checkboxes).map(cb => parseInt(cb.value));
        }

        // --- åŠŸèƒ½ 1: ç”¢ç”Ÿå­¸æœŸä¾‹è¡Œè¡¨ (æ ¸å¿ƒé‚è¼¯) ---
        function generateSemester(mode) {
            const start = document.getElementById('semStartDate').value;
            const end = document.getElementById('semEndDate').value;
            const tbody = document.querySelector('#scheduleTable tbody');

            if (!start || !end) { alert("è«‹å…ˆè¨­å®šå­¸æœŸå€é–“ï¼"); return; }

            // æ¸…ç©ºèˆŠè¡¨æ ¼ (å› ç‚ºæ˜¯ç”¢ç”Ÿæ–°å­¸æœŸ)
            tbody.innerHTML = "";
            document.getElementById('emptyMsg').style.display = 'none';

            let current = new Date(start);
            const endDate = new Date(end);
            
            // å–å¾— A/B åœ˜ä»‹é¢è¨­å®š
            const abDays = getSelectedDays('daysAB');
            const abTime = document.getElementById('timeAB').value;
            const abTextTue = document.getElementById('txtAB_Tue').value;
            const abTextThu = document.getElementById('txtAB_Thu').value;
            const abTextOther = document.getElementById('txtAB_Other').value;

            // å–å¾— çµ²ç«¹ åœ˜ä»‹é¢è¨­å®š
            const silkDays = getSelectedDays('daysSilk');
            const silkTime = document.getElementById('timeSilk').value;
            const silkText = document.getElementById('txtSilk').value;

            // è¿´åœˆéæ­·æ¯ä¸€å¤©
            while (current <= endDate) {
                const day = current.getDay();
                
                // --- é‚è¼¯ Aï¼šA/B åœ˜ ---
                if (mode === 'AB' || mode === 'All') {
                    if (abDays.includes(day)) {
                        let act = abTextOther; 
                        if (day === 2) act = abTextTue; 
                        if (day === 4) act = abTextThu; 
                        insertRow(current, act, abTime, false);
                    }
                }

                // --- é‚è¼¯ Bï¼šçµ²ç«¹åœ˜ ---
                if (mode === 'Silk' || mode === 'All') {
                    if (silkDays.includes(day)) {
                        insertRow(current, silkText, silkTime, false);
                    }
                }

                current.setDate(current.getDate() + 1);
            }
        }

        // --- åŠŸèƒ½ 2: åŠ å…¥æš‘è¨“ (ç´¯åŠ æ¨¡å¼) ---
        function addTrainingBatch() {
            const start = document.getElementById('trainStartDate').value;
            const end = document.getElementById('trainEndDate').value;
            const name = document.getElementById('trainName').value;
            const time = document.getElementById('trainTime').value;

            if (!start || !end) { alert("è«‹è¨­å®šæ—¥æœŸï¼"); return; }
            document.getElementById('emptyMsg').style.display = 'none';

            let current = new Date(start);
            const endDate = new Date(end);
            
            while (current <= endDate) {
                const day = current.getDay();
                // è‡ªå‹•è·³éé€±å…­(6)èˆ‡é€±æ—¥(0)
                if (day !== 0 && day !== 6) { 
                    insertRow(current, name, time, false); 
                }
                current.setDate(current.getDate() + 1);
            }
            // æ’å…¥å®Œç•¢å¾Œï¼ŒåŸ·è¡Œæ—¥æœŸæ’åº
            sortTable();
        }

        // --- æ ¸å¿ƒå‡½æ•¸ï¼šåœ¨è¡¨æ ¼æ’å…¥ä¸€åˆ— ---
        function insertRow(dateObj, activity, time, isManual, nextToRow = null) {
            const tbody = document.querySelector('#scheduleTable tbody');
            const row = document.createElement('tr');
            
            const isoDate = formatDate(dateObj); // ä½¿ç”¨è£œé›¶çš„æ ¼å¼ï¼Œé¿å…æ’åºéŒ¯èª¤
            row.setAttribute('data-date', isoDate);

            const dateText = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
            const dayText = daysMap[dateObj.getDay()];

            let dateHtml = isManual 
                ? `<input type="date" class="editable-cell" value="${isoDate}" onchange="updateRowDate(this)" data-tooltip="é»æ“Šä¿®æ”¹æ—¥æœŸ">` 
                : dateText;
            
            let dayHtml = isManual 
                ? `<span class="day-text">${dayText}</span>` 
                : dayText;

            row.innerHTML = `
                <td>${dateHtml}</td>
                <td>${dayHtml}</td>
                <td><input class="editable-cell" list="activityOptions" value="${activity}" placeholder="è¼¸å…¥æ´»å‹•" data-tooltip="å¯è¼¸å…¥æˆ–é¸æ“‡é è¨­é¸é …"></td>
                <td><input class="editable-cell" value="${time}" data-tooltip="ä¿®æ”¹æ™‚é–“"></td>
                <td></td><td></td><td></td>
                <td class="action-cell">
                    <button class="icon-btn add-row-btn" onclick="insertRowBelow(this)" data-tooltip="åœ¨æ­¤åˆ—ä¸‹æ–¹æ’å…¥æ–°åˆ—">ï¼‹</button>
                    <button class="icon-btn del-btn" onclick="removeRow(this)" data-tooltip="åˆªé™¤æ­¤åˆ—">Ã—</button>
                </td>
            `;

            if (nextToRow) {
                nextToRow.after(row);
            } else {
                tbody.appendChild(row);
            }
        }

        function insertRowBelow(btn) {
            const currentRow = btn.closest('tr');
            const currentDateStr = currentRow.getAttribute('data-date');
            
            const newDate = new Date(currentDateStr);
            insertRow(newDate, "", "", true, currentRow);
        }

        function removeRow(btn) { 
            btn.closest('tr').remove(); 
        }

        function updateRowDate(input) {
            const d = new Date(input.value);
            if (!isNaN(d)) {
                const row = input.closest('tr');
                row.setAttribute('data-date', input.value);
                row.querySelector('.day-text').innerText = daysMap[d.getDay()];
                sortTable();
            }
        }

        function sortTable() {
            const tbody = document.querySelector('#scheduleTable tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                const dateA = a.getAttribute('data-date');
                const dateB = b.getAttribute('data-date');
                return dateA.localeCompare(dateB);
            });

            rows.forEach(row => tbody.appendChild(row));
        }

        function clearTable() {
            if (confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å…§å®¹å—ï¼Ÿ")) {
                document.querySelector('#scheduleTable tbody').innerHTML = "";
                document.getElementById('emptyMsg').style.display = 'block';
            }
        }

        function copyTable() {
            const table = document.getElementById('scheduleTable');
            const tbody = table.querySelector('tbody');
            if (tbody.rows.length === 0) { alert("ç„¡è³‡æ–™å¯è¤‡è£½"); return; }
            
            sortTable();
            
            let csv = [];
            const ths = Array.from(table.querySelectorAll('thead th')).slice(0, -1);
            csv.push(ths.map(th => th.innerText).join('\t'));

            table.querySelectorAll('tbody tr').forEach(row => {
                const tds = Array.from(row.querySelectorAll('td')).slice(0, -1);
                const rowData = tds.map((td, idx) => {
                    const inp = td.querySelector('input');
                    if (idx === 0 && inp && inp.type === 'date') {
                        const d = new Date(inp.value);
                        return `${d.getMonth() + 1}/${d.getDate()}`;
                    }
                    return inp ? inp.value : td.innerText;
                });
                csv.push(rowData.join('\t'));
            });

            navigator.clipboard.writeText(csv.join('\n'))
                .then(() => alert("âœ… å·²è¤‡è£½æˆåŠŸï¼\nè«‹æ‰“é–‹ Excel æˆ– Google Sheet æŒ‰ä¸‹ Ctrl+V è²¼ä¸Šã€‚"))
                .catch(() => alert("âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–ã€‚"));
        }
    </script>
</body>
</html>
